jQuery(function(a){a(document).ready(function(){var q=a("#wp-qiniu-plugin-url").val(),r=a("#wp-qiniu-style-split-char").val(),i=a("#wp-qiniu-thumbnail-style").val(),m=a("#wp-qiniu-watermark-style").val(),h=a("#wp-qiniu-storage-domain").val(),z=a("#wp-admin-ajax-url").val(),d=a("#wp_qiniu_ajax_nonce").val(),s=(i)?r+i:"?imageView2/1/w/100/h/100",b=(m)?r+m:"";var v=4*1024*1024;var e=a("#wp-qiniu-upload-url").val();var c=0;var f=false;var k;var l="";var y={useCdnDomain:true,disableStatisticsReport:false,retryCount:6};var p={fname:"",params:{},mimeType:null};var u=new plupload.Uploader({url:e,runtimes:"html5,flash,html4",browse_button:"upload-pickfiles",container:"upload-container",max_file_size:"512mb",flash_swf_url:"../wp-includes/js/plupload/plupload.flash.swf",max_retries:3,dragdrop:true,drop_element:"upload-pickfiles",chunk_size:v,multi_selection:true,multipart_params:{token:l},init:{PostInit:function(){console.log("upload init")},FilesAdded:function(A,C){f=false;a("#upload-detail").show();a("#upload-success").hide();var D=a("#load-more"),B=D.attr("data-pid"),E=D.attr("data-current-path");plupload.each(C,function(G){G.pid=B;G.path=E;G.overwrite=false;G.canceled=false;var F=new x(G,"fsUploadProgress");F.setStatus("等待...");F.bindUploadCancel(A)})},FileUploaded:function(A,B,C){console.log(C)},UploadComplete:function(A,B){console.log("[完成]")},Error:function(A,B){console.log(B.response)}}});u.init();u.bind("FilesAdded",function(B,A){setTimeout(function(){B.start()},0);B.refresh()});u.bind("Error",function(D,C){console.log("file upload error.");a("#upload-detail").show();var A=new x(C.file,"fsUploadProgress");A.setError();var B=n(C.status);A.setStatus(B);console.log(C.response)});u.bind("BeforeUpload",function(E,D){var B=new x(D,"fsUploadProgress");if(D.canceled){B.fileProgressWrapper.find("td:eq(2) .progressCancel").click();return false}else{if(E.runtime==="html5"&&v){B.setChunkProgess(v)}}D.startTime=new Date();D.speed=D.speed||0;var C=D.path+D.name;D.key=C;p.params["x:name"]=C.split(".")[0];var G=D.id;l=o(E,D);var A=function(){var J={};J.token=l;var H=qiniu.filterParams(p.params);for(var K=0;K<H.length;K++){var I=H[K];J[I[0]]=I[1]}J.key=C;E.setOption({url:e,multipart:true,multipart_params:J})};var F=function(){k=v;w(D);if(k===0){t(D);E.stop();return}f=true;var I={};var H=Math.floor(D.loaded/v);var J=qiniu.getHeadersForChunkUpload(l);E.setOption({url:e+"/mkblk/"+k,multipart:false,required_features:"chunks",headers:{Authorization:"UpToken "+l},multipart_params:I})};if((E.runtime==="html5"||E.runtime==="flash")&&v){if(D.size<v){A()}else{F()}}else{console.log("directUpload because file.size < chunk_size || is_android_weixin_or_qq()");A()}});u.bind("ChunkUploaded",function(A,C,F){var B=JSON.parse(F.response);var E=F.total-F.offset;var G=u.getOption&&u.getOption("chunk_size");if(E<G){A.setOption({url:e+"/mkblk/"+E})}A.setOption({headers:{Authorization:"UpToken "+l}});var D=JSON.parse(localStorage.getItem(C.name))||[];D[c]={ctx:B.ctx,time:new Date().getTime(),offset:F.offset,percent:C.percent};c++;localStorage.setItem(C.name,JSON.stringify(D))});u.bind("UploadProgress",function(E,C){var D=(new Date).getTime();var B=D-C.startTime,F=C.loaded||0;f&&(F=C.loaded-C.resumeFilesize);C.speed=(F/B*1000).toFixed(0)||0;var A=new x(C,"fsUploadProgress");A.setProgress(C.percent+"%",C.speed,v)});u.bind("FileUploaded",function(D,B,C){if(f){t(B)}else{var A=a.parseJSON(C.response);g(A,B)}});u.bind("UploadComplete",function(){a("#upload-success").show()});function o(C,B){var A="";a.ajax({type:"GET",url:z,async:false,data:{action:"wp_qiniu_get_uptoken",pid:B.pid,fname:B.name,nonce:d},error:function(D){alert("获取文件上传token失败！")},success:function(E){if(E.status==="success"){if(E.exist){var D=confirm("已存在同名文件，覆盖原有文件？");if(D){B.overwrite=true}else{B.canceled=true}}else{B.overwrite=false}B.fname=E.fname;A=E.uptoken}else{alert(E.error)}}});return A}function g(C,B){localStorage.removeItem(B.name);if(B.overwrite){a('div.file-on-qiniu[data-file-name="'+B.name+'"]').each(function(){if(a(this).attr("data-file-type")!="dir"){a(this).remove()}})}var A=new x(B,"fsUploadProgress");A.setComplete(C)}function w(B){var D=JSON.parse(localStorage.getItem(B.name))||[];c=0;var E=D.length;if(E){var F=false;for(var A=0;A<D.length;A++){c++;if(j(D[A].time)){F=true;localStorage.removeItem(B.name);break}}if(F){c=0;return}B.loaded=D[E-1].offset;var C=B.size-B.loaded;if(C<v){k=C}B.percent=D[E-1].percent;B.resumeFilesize=B.loaded;return}else{c=0;B.percent=0;B.resumeFilesize=0}}function t(E){var F=qiniu.createMkFileUrl(e,E.size,E.key,p);var A=[];var H=E.id;var B=localStorage.getItem(E.name);if(B){var D=JSON.parse(B);for(var C=0;C<D.length;C++){A.push(D[C].ctx)}}var G=qiniu.getHeadersForMkFile(l);a.ajax({url:F,type:"POST",headers:G,data:A.join(","),success:function(I){g(I,E)},error:function(K){console.log("file upload error.");a("#upload-detail").show();var I=new x(E,"fsUploadProgress");I.setError();var J=n(K.status);I.setStatus(J);console.log(K.response)}})}function j(B){var A=B+3600*24*1000;return new Date().getTime()>A}function n(A){switch(A){case 298:return"部分操作执行成功。";case 400:return"请求报文格式错误。";case 401:return"认证授权失败。";case 403:return"权限不足，拒绝访问。";case 404:return"资源不存在。";case 405:return"请求方式错误。";case 406:return"上传的数据 CRC32 校验错误。";case 413:return"请求资源大小大于指定的最大值。";case 419:return"用户账号被冻结。";case 478:return"镜像回源失败。";case 502:return"错误网关。";case 503:return"服务端不可用。";case 504:return"服务端操作超时。";case 573:return"单个资源访问频率过高。";case 579:return"上传成功但是回调失败。";case 599:return"服务端操作失败。";case 608:return"资源内容被修改。";case 612:return"指定资源不存在或已被删除。";case 614:return"目标资源已存在。";case 630:return"已创建的空间数量达到上限，无法创建新空间。";case 631:return"指定空间不存在。";case 640:return"调用列举资源(list)接口时，指定非法的marker参数。";case 701:return"在断点续上传过程中，后续上传接收地址不正确或ctx信息已过期。。";default:return"未知错误（错误码："+A+"）。"}}a("#upload-pickfiles").on("dragenter",function(A){A.preventDefault();a("#upload-pickfiles").addClass("draging");A.stopPropagation()}).on("drop",function(A){A.preventDefault();a("#upload-pickfiles").removeClass("draging");A.stopPropagation()}).on("dragleave",function(A){A.preventDefault();a("#upload-pickfiles").removeClass("draging");A.stopPropagation()}).on("dragover",function(A){A.preventDefault();a("#upload-pickfiles").addClass("draging");A.stopPropagation()});a("body").on("click","table button.btn",function(){a(this).parents("tr").next().toggle()});function x(C,D){this.fileProgressID=C.id;this.file=C;this.opacity=100;this.height=0;this.fileProgressWrapper=a("#"+this.fileProgressID);if(!this.fileProgressWrapper.length){this.fileProgressWrapper=a("<tr></tr>");var M=this.fileProgressWrapper;M.attr("id",this.fileProgressID).addClass("progressContainer");var F=a("<td/>");F.addClass("progressName").text(C.name);var E=plupload.formatSize(C.size).toUpperCase();var G=a("<td/>");G.addClass("progressFileSize").text(E);var K=a("<td colspan='2'/>");var B=a("<div/>");B.addClass("info");var A=a("<div/>");A.addClass("progress progress-striped");var H=a("<div/>");H.addClass("progress-bar progress-bar-info").attr("role","progressbar").attr("aria-valuemax",100).attr("aria-valuenow",0).attr("aria-valuein",0).width("0%");var I=a('<span class="sr-only" />');I.text(E);var J=a('<a href=javascript:; title="取消上传"><span/></a>');J.show().addClass("progressCancel");H.append(I);A.append(H);B.append(A);B.append(J);var L=a('<div class="status text-center"/>');B.append(L);K.append(B);M.append(F);M.append(G);M.append(K);a("#"+D).append(M)}else{this.reset()}this.height=this.fileProgressWrapper.offset().top;this.setTimer(null)}x.prototype.setTimer=function(A){this.fileProgressWrapper.FP_TIMER=A};x.prototype.getTimer=function(){return this.fileProgressWrapper.FP_TIMER||null};x.prototype.reset=function(){this.fileProgressWrapper.attr("class","progressContainer");this.fileProgressWrapper.find("td .progress .progress-bar-info").attr("aria-valuenow",0).width("0%").find("span").text("");this.appear()};x.prototype.setChunkProgess=function(I){var J=Math.ceil(this.file.size/I);if(J===1){return false}var C=a('<button class="btn btn-default button">查看分块上传进度</button>');var F=a('<tr class="chunk-status-tr"><td colspan=3></td></tr>');var G=a("<div/>");for(var D=1;D<=J;D++){var B=a('<div class="col-md-2"/>');var A=a('<div class="progress progress-striped"></div>');var E=a("<div/>");E.addClass("progress-bar progress-bar-info text-left").attr("role","progressbar").attr("aria-valuemax",100).attr("aria-valuenow",0).attr("aria-valuein",0).width("0%").attr("id",this.file.id+"_"+D).text("");var H=a("<span/>");H.addClass("chunk-status").text();A.append(E);A.append(H);B.append(A);G.append(B)}if(!this.fileProgressWrapper.find("td:eq(2) .btn-default").length){this.fileProgressWrapper.find("td>div").append(C)}F.hide().find("td").append(G);F.insertAfter(this.fileProgressWrapper)};x.prototype.setProgress=function(P,E,O){this.fileProgressWrapper.attr("class","progressContainer green");var F=this.file;var B=F.loaded;var Q=plupload.formatSize(B).toUpperCase();var L=plupload.formatSize(E).toUpperCase();var H=this.fileProgressWrapper.find("td .progress").find(".progress-bar-info");if(this.fileProgressWrapper.find(".status").text()==="已取消上传"){return}this.fileProgressWrapper.find(".status").text("已上传: "+Q+" 上传速度： "+L+"/s");P=parseInt(P,10);if(F.status!==plupload.DONE&&P===100){P=99}H.attr("aria-valuenow",P).css("width",P+"%");if(O){var N=Math.ceil(F.size/O);if(N===1){return false}var D=Math.ceil(B/O);var K,M;for(var I=0;I<D;I++){K=a("#"+F.id+"_"+I);K.width("100%").removeClass().addClass("alert-success").attr("aria-valuenow",100);M="块"+I+"上传进度100%";K.next().html(M)}var G=a("#"+F.id+"_"+D);var J;if(D<N){if(B%O){J=((B%O)/O*100).toFixed(2)}else{J=100;G.removeClass().addClass("alert-success")}}else{var C=F.size-O*(N-1);var A=F.size-B;if(A%C){J=((B%O)/C*100).toFixed(2)}else{J=100;G.removeClass().addClass("alert-success")}}G.width(J+"%");G.attr("aria-valuenow",J);M="块"+D+"上传进度"+J+"%";G.next().html(M)}this.appear()};x.prototype.setComplete=function(S){var H=this.fileProgressWrapper.find("td:eq(2)"),J=H.find(".progress");var T=h;var D,N;if(S.url){D=encodeURI(S.url)}else{D=T+encodeURI(S.key)}N="<div><strong>原文件链接：:</strong><a href="+D+" target='_blank' > "+T+S.key+"</a></div><div class=hash><strong>文件Hash值：</strong>"+S.hash+"</div><div class=hash><strong>文件Key：</strong>"+S.key+"</div><br/><div><strong></strong></div>";J.html(N).removeClass().next().next(".status").hide();H.find(".progressCancel").hide();H.find(".btn").parents("tr").next().remove();H.find(".btn").remove();var G=this.fileProgressWrapper.find(".progressName");this.fileProgressWrapper.addClass("success");var R=a('<div class="Wrapper"/>');var M=a('<div class="imgWrapper col-md-3"/>');var I=a('<a class="linkWrapper" target="_blank"/>');var F=a('<img src="'+q+'img/loading.gif"/>');G.append(R);var Q=".|jpg|jpeg|png|gif|bmp|",B=".|asf|avi|flv|mkv|mov|mp4|wmv|3gp|3g2|mpeg|ts|rm|rmvb|m3u8|",P=".|ogg|mp3|wma|wav|mp3pro|mid|midi|",C=S.fname.substring(S.fname.lastIndexOf(".")+1).toLowerCase();if(Q.indexOf("|"+C+"|")>0){C="image"}else{if(B.indexOf("|"+C+"|")>0){C="video"}else{if(P.indexOf("|"+C+"|")>0){C="audio"}else{C="file"}}}if(C!=="image"&&C!=="video"){F.attr("src",q+"img/"+C+".png");R.addClass("default");M.append(F);R.append(M)}else{if(C==="image"){I.append(F);M.append(I);R.append(M);I.attr("href",D).attr("title","查看原图");F.attr("src",T+encodeURI(S.key)+s)}else{F.attr("src",q+"img/"+C+".png");R.addClass("default");M.append(F);R.append(M)}var L=a('<div class="infoWrapper col-md-6"></div>');if(b&&C==="image"){var K=a('<a href="" target="_blank">查看水印图片</a>');K.attr("href",T+encodeURI(S.key)+b).attr("title","查看水印图片");L.append(K)}var E=a("<div/>");var O='<div>格式：<span class="origin-format">'+S.format+'</span></div><div>宽度：<span class="orgin-width">'+S.width+'px</span></div><div>高度：<span class="origin-height">'+S.height+"px</span></div>";E.html(O);L.append(E);R.append(L)}var A='<div class="file-on-qiniu" data-file-name="'+S.fname+'" data-file-type="'+C+'" data-file-id="'+S.id+'" data-file-mime="'+S.mimeType+'">';A+='<div class="file-thumbnail">';if(C==="image"){A+='<img src="'+T+encodeURI(S.key)+s+'" />'}else{A+='<img src="'+q+"img/"+C+'.png" />'}A+="</div>";A+='<div class="file-name"><div class="file-text">';A+=S.fname;A+="</div></div>";A+="</div>";a("#files-on-qiniu").append(A)};x.prototype.setError=function(){this.fileProgressWrapper.find("td:eq(2)").attr("class","text-warning");this.fileProgressWrapper.find("td:eq(2) .progress").css("width",0).hide();this.fileProgressWrapper.find("button").hide();this.fileProgressWrapper.next(".chunk-status-tr").hide();this.fileProgressWrapper.addClass("danger")};x.prototype.setCancelled=function(B){var A="progressContainer";if(!B){A+=" red"}this.fileProgressWrapper.attr("class",A);this.fileProgressWrapper.find("td .progress").remove();this.fileProgressWrapper.find("td:eq(2) .btn-default").hide();this.fileProgressWrapper.find("td:eq(2) .progressCancel").hide();this.fileProgressWrapper.next(".chunk-status-tr").hide()};x.prototype.setStatus=function(B,A){if(!A){this.fileProgressWrapper.find(".status").text(B).attr("class","status text-left")}};x.prototype.bindUploadCancel=function(A){var B=this;if(A){B.fileProgressWrapper.find("td:eq(2) .progressCancel").on("click",function(){B.setCancelled(false);B.setStatus("已取消上传");B.fileProgressWrapper.find(".status").css("left","0");A.removeFile(B.file);B.fileProgressWrapper.addClass("warning")})}};x.prototype.appear=function(){if(this.getTimer()!==null){clearTimeout(this.getTimer());this.setTimer(null)}if(this.fileProgressWrapper[0].filters){try{this.fileProgressWrapper[0].filters.item("DXImageTransform.Microsoft.Alpha").opacity=100}catch(A){this.fileProgressWrapper.css("filter","progid:DXImageTransform.Microsoft.Alpha(opacity=100)")}}else{this.fileProgressWrapper.css("opacity",1)}this.fileProgressWrapper.css("height","");this.height=this.fileProgressWrapper.offset().top;this.opacity=100;this.fileProgressWrapper.show()}})});