jQuery((function($){$("div.file-on-qiniu").live("click",(function(e){$(this).toggleClass("selected");var divSelected=$("div.file-on-qiniu.selected");divSelected.length>0?($("#btn-delete").attr("disabled",!1),$("#btn-clear").attr("disabled",!1)):($("#btn-delete").attr("disabled",!0),$("#btn-clear").attr("disabled",!0)),1==divSelected.length?$("#btn-rename").attr("disabled",!1):$("#btn-rename").attr("disabled",!0),$('div[data-file-type!="dir"].file-on-qiniu.selected').length>0?$("#btn-insert").attr("disabled",!1):$("#btn-insert").attr("disabled",!0)})),$("#btn-insert").live("click",(function(){var divSelFiles=$('div[data-file-type!="dir"].file-on-qiniu.selected');if(divSelFiles.length>0){var root_url=$("#wp-qiniu-storage-domain").val(),pkey=$("#load-more").attr("data-current-path"),nhtml="";divSelFiles.each((function(){var $this=$(this),fname=$this.attr("data-file-name"),ftype=$this.attr("data-file-type"),fmime=$this.attr("data-file-mime"),fkey=pkey+fname;if("image"==ftype){var watermark="";$("#wp-qiniu-watermark-style").val()&&(watermark=$("#wp-qiniu-style-split-char").val()+$("#wp-qiniu-watermark-style").val());var img_src=root_url+encodeURI(fkey+watermark),insert="";insert=$("#wp-qiniu-insert-style").val()?$("#wp-qiniu-style-split-char").val()+$("#wp-qiniu-insert-style").val():watermark;var img_insert=root_url+encodeURI(fkey+insert);nhtml+='<a href="'+img_src+'"><img src="'+img_insert+'" alt="'+fname+'" /></a>'}else nhtml+="video"==ftype?'[qiniuvideo key="'+fkey+'" width="600" height="400" type="'+fmime+'"]':"audio"==ftype?'[qiniuaudio key="'+fkey+'" titles="'+fname+'" artists="" autostart="no" loop="no" type="'+fmime+'"]':'[qiniufile key="'+fkey+'" name="'+fname+'" type="'+fmime+'"]'})),divSelFiles.removeClass("selected"),window.parent.send_to_editor(nhtml),window.parent.tb_remove()}else alert("请选择要插入的文件！")})),$("#btn-close").click((function(){window.parent.tb_remove()})),$("#btn-clear").click((function(){var divSelFiles;$("div.file-on-qiniu.selected").removeClass("selected"),$("#btn-delete").attr("disabled",!0),$("#btn-clear").attr("disabled",!0),$("#btn-insert").attr("disabled",!0),$("#btn-rename").attr("disabled",!0)})),$("#btn-reload").click((function(){$("#files-on-qiniu").empty(),$("#btn-clear").click();var divLoadMore=$("#load-more");divLoadMore.attr("data-paged",1),divLoadMore.attr("data-loading","false"),divLoadMore.attr("class","page-navi"),divLoadMore.text("加载更多"),divLoadMore.click()})),$("#show-upload-area").toggle((function(e){e.preventDefault(),$("#files-on-qiniu,#load-more,#prev-page,#manage-buttons").hide(),$("#upload-to-qiniu-area").show(),$("#wp-qiniu-path-navi").find("a").attr("class","link-Disabled"),$(this).text("返回列表")}),(function(e){e.preventDefault(),$("#upload-to-qiniu-area").hide();var divPathNavi=$("#wp-qiniu-path-navi");divPathNavi.find("a").attr("class","link-Active"),divPathNavi.find("a:last").attr("class","link-Disabled"),$("#files-on-qiniu,#load-more,#prev-page,#manage-buttons").show(),$(this).text("上传到这里")})),$("#load-more").live("click",(function(e){e.preventDefault();var $this=$(this),loading=$this.attr("data-loading"),pid=$this.attr("data-pid"),paged=$this.attr("data-paged"),pagesize=$this.attr("data-pagesize"),workPath=$this.attr("data-current-path"),interval=$this.attr("timer-int");"true"!=loading&&("undefined"!=interval&&clearInterval(interval),$.ajax({type:"POST",dataType:"json",url:$("#wp-admin-ajax-url").val(),data:{action:"wp_qiniu_list_files",pid:pid,paged:paged,pagesize:pagesize,orderby:$('input[name="wp-qiniu-file-orderby"]:checked').val(),nonce:$("#wp_qiniu_ajax_nonce").val()},beforeSend:function(){function fileLoad(){var text=$this.text();text.length<14&&text.length>=4?$this.text(text+" ."):$this.text("正在加载 .")}$this.attr("class","page-navi-disable"),$this.attr("data-loading","true"),$this.text("正在加载"),interval=setInterval(fileLoad,1e3),$this.attr("timer-int",interval)},success:function(data,textStatus){if(clearInterval(interval),"success"!=data.status)return alert(data.status),$this.attr("data-loading","false"),$this.text("加载失败！点击后重新加载。Error："+data.error),void $this.attr("class","page-navi");for(var filelists=data.data,dirUrl=$("#wp-qiniu-storage-domain").val()+encodeURI($this.attr("data-current-path")),pluginUrl=$("#wp-qiniu-plugin-url").val(),thumbnailStyle=$("#wp-qiniu-style-split-char").val()+$("#wp-qiniu-thumbnail-style").val(),ftype="",i=0;i<filelists.length;i++){var id=filelists[i].id,isdir=filelists[i].isdir,fname=filelists[i].fname,fsize=filelists[i].fsize,ctime=filelists[i].ctime,width=filelists[i].width,height=filelists[i].height,fmime=filelists[i].mimeType,imgArr=".|jpg|jpeg|png|gif|bmp|",videoArr=".|asf|avi|flv|mkv|mov|mp4|wmv|3gp|3g2|mpeg|ts|rm|rmvb|m3u8|",audioArr=".|ogg|mp3|wma|wav|mp3pro|mid|midi|";ftype=1==isdir?"dir":fname.substring(fname.lastIndexOf(".")+1).toLowerCase(),imgArr.indexOf("|"+ftype+"|")>0?ftype="image":videoArr.indexOf("|"+ftype+"|")>0?ftype="video":audioArr.indexOf("|"+ftype+"|")>0?ftype="audio":0==isdir&&(ftype="file");var fnode_html='<div class="file-on-qiniu"'+("dir"!==ftype?' title="双击复制连接到剪贴板"':"")+' data-file-name="'+fname+'" data-file-type="'+ftype+'" data-file-id="'+id+'" data-file-mime="'+fmime+'">';if(fnode_html+='<div class="file-thumbnail">',fnode_html+="image"==ftype?'<img src="'+dirUrl+encodeURI(fname)+thumbnailStyle+'" />':'<img src="'+pluginUrl+"img/"+ftype+'.png" />',fnode_html+="</div>",fnode_html+='<div class="file-name"><div class="file-text">',fnode_html+=fname,fnode_html+="</div></div>",fnode_html+="</div>",workPath!=$this.attr("data-current-path"))return;$("#files-on-qiniu").append(fnode_html)}$this.attr("data-paged",++paged),filelists.length<pagesize?($this.attr("data-loading","true"),$this.text("已全部加载完成"),$this.attr("class","page-navi-disable")):($this.attr("data-loading","false"),$this.text("加载更多"),$this.attr("class","page-navi"))},error:function(XMLHttpRequest,textStatus,errorThrown){if(clearInterval(interval),$this.attr("data-loading","false"),$this.attr("class","page-navi"),XMLHttpRequest.responseText){var res=JSON.parse(XMLHttpRequest.responseText);$this.text("加载失败！点击后重新加载。"+res.error+", "+XMLHttpRequest.status+": "+errorThrown+", status: "+textStatus)}else $this.text("加载失败！点击后重新加载。"+XMLHttpRequest.status+": "+errorThrown+", status: "+textStatus)},complete:function(XMLHttpRequest,textStatus){$this.removeAttr("timer-int")}}))})),$(document).ready((function(){$("#load-more").click()})),$('div.file-on-qiniu[data-file-type="dir"]').live("dblclick",(function(e){$("#btn-clear").click();var $this=$(this),pid=$this.attr("data-file-id"),fname=$this.attr("data-file-name"),divLoadMore=$("#load-more"),fpath=divLoadMore.attr("data-current-path")+fname+"/";divLoadMore.attr("data-pid",pid),divLoadMore.attr("data-paged",1),divLoadMore.attr("data-current-path",fpath),$("#files-on-qiniu").empty();var lhtml='/<a class="link-Disabled" href="javascript:void(0)" data-file-path="'+fpath+'" data-file-id="'+pid+'">'+fname+"</a>",divPathNavi=$("#wp-qiniu-path-navi");divPathNavi.find("a.link-Disabled").attr("class","link-Active"),divPathNavi.append(lhtml),divLoadMore.text("加载更多"),divLoadMore.attr("class","page-navi"),divLoadMore.attr("data-loading","false"),divLoadMore.click()})),$('div.file-on-qiniu[data-file-type!="dir"]').live("dblclick",(function(e){var $this=$(this),root_url=$("#wp-qiniu-storage-domain").val(),ftype=$this.attr("data-file-type"),fkey=$("#load-more").attr("data-current-path")+$this.attr("data-file-name"),flink="",watermark="";"image"==ftype&&$("#wp-qiniu-watermark-style").val()&&(watermark=$("#wp-qiniu-style-split-char").val()+$("#wp-qiniu-watermark-style").val()),flink=root_url+encodeURI(fkey+watermark),$("#btn-copy").attr("data-clipboard-text",flink),new ClipboardJS("#btn-copy"),$("#btn-copy").click()})),$("#wp-qiniu-path-navi").find("a.link-Active").live("click",(function(e){$("#btn-clear").click();var $this=$(this),pid=$this.attr("data-file-id"),fpath=$this.attr("data-file-path"),divLoadMore=$("#load-more"),divPathNavi=$("#wp-qiniu-path-navi"),phtml=divPathNavi.html();divLoadMore.attr("data-pid",pid),divLoadMore.attr("data-paged",1),divLoadMore.attr("data-current-path",fpath),$("#files-on-qiniu").empty();var i=phtml.indexOf("</a>",phtml.indexOf('data-file-id="'+pid+'">')),naviHtml=phtml.substring(0,i+4);divPathNavi.html(naviHtml),divPathNavi.find("a:last").attr("class","link-Disabled"),divLoadMore.text("加载更多"),divLoadMore.attr("class","page-navi"),divLoadMore.attr("data-loading","false"),divLoadMore.click()})),$("#btn-newdir").click((function(){var dirname=prompt("请输入文件夹的名称（请勿使用特殊字符及系统保留字符）：","新建文件夹");if(null!=dirname){if(""==dirname.trim(" "))return alert("文件夹名不能为空！"),!1;for(var $this=$(this),dircheck=!0,fNode=$('div.file-on-qiniu[data-file-type="dir"]:first');fNode&&fNode.length&&fNode.length>0;){if(dirname==fNode.attr("data-file-name")){alert("已存在相同名称的文件夹！"),$this.attr("disabled",!1),dircheck=!1;break}fNode=fNode.next('div.file-on-qiniu[data-file-type="dir"]')}if(dircheck){var loadmore=$("#load-more"),pid=loadmore.attr("data-pid"),workPath=loadmore.attr("data-current-path");$.ajax({type:"POST",dataType:"json",url:$("#wp-admin-ajax-url").val(),data:{action:"wp_qiniu_create_floder",pid:pid,dirname:dirname,nonce:$("#wp_qiniu_ajax_nonce").val()},beforeSend:function(){$this.attr("disabled",!0)},success:function(data,textStatus){if("success"==data.status){var id=data.id,isdir=data.isdir,fname=data.fname,ctime=data.ctime,fmime,ftype="dir",pluginUrl,fnode_html='<div class="file-on-qiniu" data-file-name="'+fname+'" data-file-type="dir" data-file-id="'+id+'" data-file-mime="'+data.mimeType+'">';fnode_html+='<div class="file-thumbnail">',fnode_html+='<img src="'+$("#wp-qiniu-plugin-url").val()+'img/dir.png" />',fnode_html+="</div>",fnode_html+='<div class="file-name"><div class="file-text">',fnode_html+=fname,fnode_html+="</div></div>",fnode_html+="</div>",workPath==$("#load-more").attr("data-current-path")&&$("#files-on-qiniu").append(fnode_html)}else alert("文件夹创建失败！Error："+data.error)},error:function(XMLHttpRequest,textStatus,errorThrown){if(XMLHttpRequest.responseText){var res=JSON.parse(XMLHttpRequest.responseText);alert("文件夹创建失败！"+res.error+", "+XMLHttpRequest.status+": "+errorThrown+", status: "+textStatus)}else alert("文件夹创建失败！"+XMLHttpRequest.status+": "+errorThrown+", status: "+textStatus)},complete:function(XMLHttpRequest,textStatus){$this.attr("disabled",!1)}})}}})),$("#btn-delete").click((function(){var rst;if(0!=confirm("你确定要删除选定的所有文件及文件夹吗？文件删除后将不可恢复！如果文件较多将需要较长时间。")){var $this=$(this),pid=$("#load-more").attr("data-pid"),files=new Array,i=0;$("div.file-on-qiniu.selected").each((function(){var id=$(this).attr("data-file-id");files[i]=id,i++})),$.ajax({type:"post",dataType:"json",url:$("#wp-admin-ajax-url").val(),data:{action:"wp_qiniu_delete_files",files:files,nonce:$("#wp_qiniu_ajax_nonce").val()},beforeSend:function(XMLHttpRequest){$this.attr("disabled",!0),$("#btn-clear").attr("disabled",!0),$("#btn-insert").attr("disabled",!0),$("#btn-reload").attr("disabled",!0),$("#btn-rename").attr("disabled",!0)},success:function(data,textStatus){if("success"!=data.status)return alert("删除失败！Error："+data.error),void $this.attr("disabled",!1);for(var deled=data.data,allDel=!0,divFiles=$("#files-on-qiniu"),i=0;i<deled.length;i++){if(pid!=$("#load-more").attr("data-pid"))return void $this.attr("disabled",!1);deled[i].result&&divFiles.find('div.file-on-qiniu[data-file-id="'+deled[i].id+'"]').remove(),allDel&=deled[i].result}allDel?alert("已成功删除所有选定的文件或文件夹。"):alert("部分文件未能成功删除，如需继续删除，请刷新后再操作。")},error:function(XMLHttpRequest,textStatus,errorThrown){if(XMLHttpRequest.responseText){var res=JSON.parse(XMLHttpRequest.responseText);alert("删除失败！"+res.error+", "+XMLHttpRequest.status+": "+errorThrown+", status: "+textStatus)}else alert("删除失败！"+XMLHttpRequest.status+": "+errorThrown+", status: "+textStatus)},complete:function(XMLHttpRequest,textStatus){var divSelected=$("div.file-on-qiniu.selected");divSelected.length>0?($("#btn-delete").attr("disabled",!1),$("#btn-clear").attr("disabled",!1)):($("#btn-delete").attr("disabled",!0),$("#btn-clear").attr("disabled",!0)),1==divSelected.length?$("#btn-rename").attr("disabled",!1):$("#btn-rename").attr("disabled",!0),$('div[data-file-type!="dir"].file-on-qiniu.selected').length>0?$("#btn-insert").attr("disabled",!1):$("#btn-insert").attr("disabled",!0),$("#btn-reload").attr("disabled",!1)}})}})),$("#btn-rename").click((function(){var divRename=$("div.file-on-qiniu.selected"),oldName=divRename.attr("data-file-name"),ftype=divRename.attr("data-file-type"),id=divRename.attr("data-file-id"),newName=prompt("请输入新名称（请勿使用特殊字符及系统保留字符）：",oldName);if(null==newName)return!1;if(""==newName.trim(" "))return alert("新名称不能为空！"),!1;var $this=$(this),nameCheck=!0,fNode;for(fNode=$("dir"==ftype?'div.file-on-qiniu[data-file-type="dir"]:first':'div.file-on-qiniu[data-file-type!="dir"]:first');fNode&&fNode.length&&fNode.length>0;){if(newName==fNode.attr("data-file-name")){"dir"==ftype?alert("已存在相同名称的文件夹！"):alert("已存在相同名称的文件！"),$this.attr("disabled",!1),nameCheck=!1;break}fNode="dir"==ftype?fNode.next('div.file-on-qiniu[data-file-type="dir"]'):fNode.next('div.file-on-qiniu[data-file-type!="dir"]')}nameCheck&&$.ajax({type:"POST",dataType:"json",url:$("#wp-admin-ajax-url").val(),data:{action:"wp_qiniu_file_rename",id:id,newname:newName,nonce:$("#wp_qiniu_ajax_nonce").val()},beforeSend:function(){$this.attr("disabled",!0),$("#btn-reload").attr("disabled",!0),$("#btn-insert").attr("disabled",!0),$("#btn-delete").attr("disabled",!0),$("#show-upload-area").attr("disabled",!0)},success:function(data,textStatus){"success"==data.status?(divRename.attr("data-file-name",data.fname),divRename.find("div.file-text").text(data.fname)):alert("重命名失败！Error："+data.error)},error:function(XMLHttpRequest,textStatus,errorThrown){if(XMLHttpRequest.responseText){var res=JSON.parse(XMLHttpRequest.responseText);alert("重命名失败！"+res.error+", "+XMLHttpRequest.status+": "+errorThrown+", status: "+textStatus)}else alert("重命名失败！"+XMLHttpRequest.status+": "+errorThrown+", status: "+textStatus)},complete:function(XMLHttpRequest,textStatus){var divSelected=$("div.file-on-qiniu.selected");divSelected.length>0?$("#btn-delete").attr("disabled",!1):$("#btn-delete").attr("disabled",!0),1==divSelected.length?$("#btn-rename").attr("disabled",!1):$("#btn-rename").attr("disabled",!0),$('div[data-file-type!="dir"].file-on-qiniu.selected').length>0?$("#btn-insert").attr("disabled",!1):$("#btn-insert").attr("disabled",!0),$("#btn-reload").attr("disabled",!1),$("#show-upload-area").attr("disabled",!1)}})})),$("#btn-sync").click((function(){var rst;if(0!=confirm("您确定要同步当前目录下的文件及文件信息吗？")){$("#btn-clear").click();var $this=$(this),divLoadMore=$("#load-more"),pid=divLoadMore.attr("data-pid"),interval=divLoadMore.attr("timer-int");$("#files-on-qiniu").empty(),divLoadMore.attr("data-paged",1),"undefined"!=interval&&clearInterval(interval),$.ajax({type:"POST",dataType:"json",url:$("#wp-admin-ajax-url").val(),data:{action:"wp_qiniu_file_sync",pid:pid,nonce:$("#wp_qiniu_ajax_nonce").val()},beforeSend:function(){function filesync(){var text=divLoadMore.text();text.length<14&&text.length>=4?divLoadMore.text(text+" ."):divLoadMore.text("正在同步 .")}$("#btn-clear").attr("disabled",!0),divLoadMore.attr("data-loading","true"),divLoadMore.attr("class","page-navi-disable"),divLoadMore.text("正在同步"),interval=setInterval(filesync,1e3),divLoadMore.attr("timer-int",interval)},success:function(data,textStatus){clearInterval(interval),divLoadMore.attr("class","page-navi"),divLoadMore.attr("data-loading","false"),"success"!=data.status?divLoadMore.text("同步失败！  Error："+data.error):(alert("同步完成！"),divLoadMore.click())},error:function(XMLHttpRequest,textStatus,errorThrown){if(clearInterval(interval),divLoadMore.attr("data-loading","false"),divLoadMore.attr("class","page-navi"),XMLHttpRequest.responseText){var res=JSON.parse(XMLHttpRequest.responseText);divLoadMore.text("同步失败！"+res.error+", "+XMLHttpRequest.status+": "+errorThrown+", status: "+textStatus)}else divLoadMore.text("同步失败！"+XMLHttpRequest.status+": "+errorThrown+", status: "+textStatus)},complete:function(XMLHttpRequest,textStatus){divLoadMore.removeAttr("timer-int")}})}}))}));